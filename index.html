<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolCheck - Manajemen Absensi & Tugas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Tambahkan Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF6F8; /* Light pink background */
        }
        .login-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            padding: 2.5rem;
        }
        .btn-primary {
            background-color: #EC4899; /* Pink-500 */
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:hover {
            background-color: #DB2777; /* Pink-600 */
        }
        .btn-primary:disabled {
            background-color: #fbcfe8;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #fce7f3;
            color: #be185d;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #fbcfe8;
        }
        .input-field {
            border: 1px solid #FBCFE8; /* Pink-200 */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: #EC4899;
            box-shadow: 0 0 0 3px #FCE7F3; /* Pink-100 */
        }
        .nav-item {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            color: #831843; /* Pink-900 */
        }
        .nav-item.active, .nav-item:hover {
            background-color: #FCE7F3; /* Pink-100 */
            color: #BE185D; /* Pink-700 */
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        .status-hadir { background-color: #D1FAE5; color: #065F46; }
        .status-izin { background-color: #FEF3C7; color: #92400E; }
        .status-sakit { background-color: #DBEAFE; color: #1E40AF; }
        .status-alfa { background-color: #FEE2E2; color: #991B1B; }
        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin .75s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- CONTAINER UTAMA -->
    <div id="app" class="w-full max-w-7xl mx-auto">

        <!-- ===== HALAMAN LOGIN & REGISTER ===== -->
        <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center">
            <div class="w-full max-w-md">
                <div class="login-card text-center">
                    <img id="logo" alt="SchoolCheck Logo" class="w-48 mx-auto mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Selamat Datang!</h1>
                    <p class="text-gray-500 mb-8">Silakan masuk untuk melanjutkan</p>

                    <!-- Login Form -->
                    <div id="login-form">
                        <div class="space-y-4">
                            <select id="role-selector" class="input-field">
                                <option value="siswa">Masuk sebagai Siswa</option>
                                <option value="guru">Masuk sebagai Guru</option>
                                <option value="admin">Masuk sebagai Admin</option>
                            </select>
                            <input type="text" id="username" placeholder="Username" class="input-field">
                            <input type="password" id="password" placeholder="Password" class="input-field">
                        </div>
                        <button onclick="handleLogin()" id="login-button" class="btn-primary w-full mt-8">Masuk</button>
                        <p id="login-error" class="text-red-500 mt-4 h-4"></p>
                    </div>

                    <!-- Register Form -->
                    <div id="register-form" class="hidden">
                        <div class="space-y-4">
                            <input type="text" id="register-name" placeholder="Nama Lengkap" class="input-field">
                            <input type="text" id="register-username" placeholder="Username Baru" class="input-field">
                            <input type="password" id="register-password" placeholder="Password Baru" class="input-field">
                            <input type="text" id="register-token" placeholder="Token Kelas" class="input-field">
                        </div>
                        <button onclick="handleRegister()" id="register-button" class="btn-primary w-full mt-8">Daftar</button>
                        <p id="register-error" class="text-red-500 mt-4 h-4"></p>
                    </div>

                    <p class="text-sm text-gray-600 mt-6">
                        <span id="login-text">Belum punya akun? <span id="show-register-btn" class="font-semibold text-pink-600 cursor-pointer hover:underline">Daftar di sini</span></span>
                        <span id="register-text" class="hidden">Sudah punya akun? <span id="show-login-btn" class="font-semibold text-pink-600 cursor-pointer hover:underline">Masuk di sini</span></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- ===== DASHBOARD UTAMA (setelah login) ===== -->
        <div id="main-dashboard" class="w-full hidden">
            <header class="bg-white shadow-md rounded-2xl p-4 mb-6 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img id="dashboard-logo" alt="SchoolCheck Logo" class="w-32">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Halo, <span id="user-name"></span>!</h2>
                        <p class="text-sm text-gray-500">Anda masuk sebagai <span id="user-role" class="font-semibold"></span></p>
                    </div>
                </div>
                <button onclick="handleLogout()" class="text-gray-500 hover:text-pink-600 transition-colors">
                    <i class="fas fa-sign-out-alt fa-lg mr-2"></i>Keluar
                </button>
            </header>
            
            <main id="app-content"></main>
        </div>

    </div>

    <!-- ===== MODAL CONTAINER ===== -->
    <div id="form-modal-container"></div>


    <!-- Template Konten untuk setiap Role -->

    <!-- ===== TEMPLATE ADMIN ===== -->
    <template id="admin-template">
        <div class="flex space-x-6">
            <aside class="w-1/4">
                <div class="card space-y-2">
                    <div id="admin-nav-dashboard" class="nav-item active" onclick="switchAdminView('dashboard')"><i class="fas fa-chart-pie w-6"></i> Dashboard</div>
                    <div id="admin-nav-guru" class="nav-item" onclick="switchAdminView('guru')"><i class="fas fa-chalkboard-teacher w-6"></i> Kelola Guru</div>
                    <div id="admin-nav-siswa" class="nav-item" onclick="switchAdminView('siswa')"><i class="fas fa-user-graduate w-6"></i> Kelola Siswa</div>
                    <div id="admin-nav-kelas" class="nav-item" onclick="switchAdminView('kelas')"><i class="fas fa-school w-6"></i> Kelola Kelas</div>
                </div>
            </aside>
            <div class="w-3/4">
                <div id="admin-view-content" class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-pink-400"></i></div>
            </div>
        </div>
    </template>
    
    <!-- ADMIN: Dashboard View -->
    <template id="admin-dashboard-view">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card text-center">
                <i class="fas fa-chalkboard-teacher text-4xl text-pink-500 mb-3"></i>
                <p class="text-5xl font-bold text-gray-800" id="admin-total-guru">0</p>
                <p class="text-gray-500">Total Guru</p>
            </div>
            <div class="card text-center">
                <i class="fas fa-user-graduate text-4xl text-pink-500 mb-3"></i>
                <p class="text-5xl font-bold text-gray-800" id="admin-total-siswa">0</p>
                <p class="text-gray-500">Total Siswa</p>
            </div>
            <div class="card text-center">
                <i class="fas fa-school text-4xl text-pink-500 mb-3"></i>
                <p class="text-5xl font-bold text-gray-800" id="admin-total-kelas">0</p>
                <p class="text-gray-500">Total Kelas</p>
            </div>
        </div>
        <div class="card mt-6">
            <h3 class="font-bold text-lg mb-4 text-gray-700">Aktivitas Sistem</h3>
            <canvas id="admin-chart"></canvas>
        </div>
    </template>

    <!-- ADMIN: Kelola Guru View -->
    <template id="admin-guru-view">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-gray-700">Daftar Guru</h3>
                <button onclick="showFormModal('guru')" class="btn-primary text-sm"><i class="fas fa-plus mr-2"></i> Tambah Guru</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-pink-50 text-pink-800">
                        <tr>
                            <th class="p-3 rounded-l-lg">Nama</th>
                            <th class="p-3">Username</th>
                            <th class="p-3">Kelas yang Diampu</th>
                            <th class="p-3 rounded-r-lg">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="admin-guru-list">
                        <!-- Data Guru dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <!-- ADMIN: Kelola Siswa View -->
    <template id="admin-siswa-view">
         <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-gray-700">Daftar Siswa</h3>
                <button onclick="showFormModal('siswa')" class="btn-primary text-sm"><i class="fas fa-plus mr-2"></i> Tambah Siswa</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-pink-50 text-pink-800">
                        <tr>
                            <th class="p-3 rounded-l-lg">Nama</th>
                            <th class="p-3">Username</th>
                            <th class="p-3">Kelas</th>
                            <th class="p-3 rounded-r-lg">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="admin-siswa-list">
                        <!-- Data Siswa dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

     <!-- ADMIN: Kelola Kelas View -->
    <template id="admin-kelas-view">
         <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-gray-700">Daftar Kelas</h3>
                <button onclick="showFormModal('kelas')" class="btn-primary text-sm"><i class="fas fa-plus mr-2"></i> Buat Kelas Baru</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-pink-50 text-pink-800">
                        <tr>
                            <th class="p-3 rounded-l-lg">Nama Kelas</th>
                            <th class="p-3">Token Kelas</th>
                            <th class="p-3">Wali Kelas</th>
                            <th class="p-3">Jumlah Siswa</th>
                            <th class="p-3 rounded-r-lg">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="admin-kelas-list">
                        <!-- Data Kelas dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>
    
    <!-- ADMIN: Modal Forms -->
    <template id="admin-form-guru">
        <h3 class="font-bold text-xl text-gray-800 mb-4">Tambah Guru Baru</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Nama Lengkap</label>
                <input type="text" id="form-guru-name" class="input-field" placeholder="Contoh: Budi Santoso">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Username</label>
                <input type="text" id="form-guru-username" class="input-field" placeholder="Contoh: budi.guru">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Password</label>
                <input type="password" id="form-guru-password" class="input-field" placeholder="Minimal 3 karakter">
            </div>
        </div>
    </template>
    <template id="admin-form-siswa">
        <h3 class="font-bold text-xl text-gray-800 mb-4">Tambah Siswa Baru</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Nama Lengkap</label>
                <input type="text" id="form-siswa-name" class="input-field" placeholder="Contoh: Ani Suryani">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Username</label>
                <input type="text" id="form-siswa-username" class="input-field" placeholder="Contoh: ani.siswa">
            </div>
             <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Password</label>
                <input type="password" id="form-siswa-password" class="input-field" placeholder="Minimal 3 karakter">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Kelas</label>
                <select id="form-siswa-kelas" class="input-field"></select>
            </div>
        </div>
    </template>
    <template id="admin-form-kelas">
        <h3 class="font-bold text-xl text-gray-800 mb-4">Buat Kelas Baru</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Nama Kelas</label>
                <input type="text" id="form-kelas-name" class="input-field" placeholder="Contoh: Kelas 12 IPA 1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 text-left mb-1">Wali Kelas</label>
                <select id="form-kelas-guru" class="input-field"></select>
            </div>
        </div>
    </template>


    <!-- ===== TEMPLATE GURU ===== -->
    <template id="guru-template">
        <div class="flex flex-col space-y-6">
            <div>
                <h3 class="font-semibold text-lg text-gray-600 mb-2">Pilih Kelas</h3>
                <select id="guru-class-selector" class="input-field max-w-sm" onchange="renderGuruContent()">
                    <!-- Opsi kelas dimuat di sini -->
                </select>
            </div>
            <div id="guru-content-area">
                <!-- Konten kelas (absensi/tugas) dimuat di sini -->
            </div>
        </div>
    </template>

    <template id="guru-content-template">
        <div class="flex space-x-6">
            <aside class="w-1/4">
                <div class="card space-y-2">
                    <div id="guru-nav-absensi" class="nav-item active" onclick="switchGuruView('absensi')"><i class="fas fa-user-check w-6"></i> Absensi</div>
                    <div id="guru-nav-tugas" class="nav-item" onclick="switchGuruView('tugas')"><i class="fas fa-book-open w-6"></i> Manajemen Tugas</div>
                    <div id="guru-nav-laporan" class="nav-item" onclick="switchGuruView('laporan')"><i class="fas fa-chart-line w-6"></i> Laporan Siswa</div>
                </div>
            </aside>
            <div class="w-3/4">
                <div id="guru-view-content" class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-pink-400"></i></div>
            </div>
        </div>
    </template>
    
    <!-- GURU: Absensi View -->
    <template id="guru-absensi-view">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-gray-700">Absensi Kelas - <span class="font-normal" id="absensi-tanggal"></span></h3>
                <button onclick="handleSaveAttendance()" id="save-attendance-button" class="btn-primary text-sm"><i class="fas fa-save mr-2"></i> Simpan Absensi</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-pink-50 text-pink-800">
                        <tr>
                            <th class="p-3 rounded-l-lg">Nama Siswa</th>
                            <th class="p-3 text-center" colspan="4">Status Kehadiran</th>
                        </tr>
                    </thead>
                    <tbody id="guru-absensi-list"></tbody>
                </table>
            </div>
        </div>
    </template>

    <!-- GURU: Tugas View -->
    <template id="guru-tugas-view">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-gray-700">Manajemen Tugas</h3>
                <button class="btn-primary text-sm"><i class="fas fa-plus mr-2"></i> Buat Tugas Baru</button>
            </div>
            <div id="guru-tugas-list" class="space-y-4"></div>
        </div>
    </template>
    
    <!-- GURU: Laporan View -->
    <template id="guru-laporan-view">
        <div class="card">
             <h3 class="font-bold text-xl text-gray-700 mb-4">Laporan Absensi Kelas</h3>
             <canvas id="guru-chart-absensi"></canvas>
        </div>
    </template>

    <!-- ===== TEMPLATE SISWA ===== -->
    <template id="siswa-template">
        <div class="flex space-x-6">
            <aside class="w-1/4">
                <div class="card space-y-2">
                    <div id="siswa-nav-dashboard" class="nav-item active" onclick="switchSiswaView('dashboard')"><i class="fas fa-home w-6"></i> Dashboard</div>
                    <div id="siswa-nav-tugas" class="nav-item" onclick="switchSiswaView('tugas')"><i class="fas fa-tasks w-6"></i> Tugas Saya</div>
                    <div id="siswa-nav-riwayat" class="nav-item" onclick="switchSiswaView('riwayat')"><i class="fas fa-history w-6"></i> Riwayat &amp; Nilai</div>
                </div>
            </aside>
            <div class="w-3/4">
                <div id="siswa-view-content" class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-pink-400"></i></div>
            </div>
        </div>
    </template>
    
    <!-- SISWA: Dashboard View -->
    <template id="siswa-dashboard-view">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card">
                <h3 class="font-bold text-lg mb-4 text-gray-700">Ringkasan Absensi Bulan Ini</h3>
                <canvas id="siswa-chart-absensi"></canvas>
            </div>
            <div class="card">
                <h3 class="font-bold text-lg mb-4 text-gray-700">Tugas Mendatang</h3>
                <div id="siswa-upcoming-tugas" class="space-y-3">
                    <p class="text-gray-500">Tidak ada tugas yang akan datang.</p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- SISWA: Tugas View -->
    <template id="siswa-tugas-view">
        <div class="card">
            <h3 class="font-bold text-xl text-gray-700 mb-4">Daftar Tugas</h3>
            <div id="siswa-tugas-list" class="space-y-4"></div>
        </div>
    </template>
    
    <!-- SISWA: Riwayat View -->
    <template id="siswa-riwayat-view">
        <div class="card">
             <h3 class="font-bold text-xl text-gray-700 mb-4">Riwayat Nilai Tugas</h3>
             <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-pink-50 text-pink-800">
                        <tr>
                            <th class="p-3 rounded-l-lg">Judul Tugas</th>
                            <th class="p-3">Tanggal Kumpul</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Nilai</th>
                            <th class="p-3 rounded-r-lg">Feedback Guru</th>
                        </tr>
                    </thead>
                    <tbody id="siswa-riwayat-list">
                        <tr><td colspan="5" class="p-4 text-center text-gray-500">Tidak ada riwayat tugas.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <script>
    // Logo Data URI
    const logoUrl = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIbGNtcwIQAABtbnRyUkdCIFhZWiAH4gADABQACQAOAB1hY3NwTVNGVAAAAABzYXdzY3RybAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWhhbmSdkQA9QICwPUB0LIGepS0o444sXwu75cnihUAAAAAAABhjcHJ0AAAB+AAAADh3dHB0AAACDAAAABRyWFlaAAACGwAAABRiWFlaAAACLAAAABRnWFlaAAACQAAAABRyVFJDAAACVAAACAxhVFJDAAACVAAACAxiVFJDAAACVAAACAxjaGFkAAAC4AAAACxicHJ0AAADAAAAABRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABQAAAAcAEQAaQBnAGkAdABhAGwAIABJAG0AYQBnAGkAbgBnAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAEcASQBNAFAAAAAAbWx1YwAAAAAAAAABAAAADGVuVVMAAAAWAAAAHABQAHUAYgBsAGkAYwAgAEQAbwBtAGEAaQBuAABYWVogAAAAAAAA81EAAQAAAAEWzFhZWiAAAAAAAAAAAAAAAAAAAAAAY3VydgAAAAAAAAABAjMAAGN1cnYAAAAAAAAAAQIzAABjdXJ2AAAAAAAAAAECMwAAWFlaIAAAAAAAAJwYAABAAAAA/8hYAFhZWiAAAAAAAABwMwAAnQAAADDAWFlaIAAAAAAAAPhZAABPLgAAb6dhY3NwAAAAAAAAAERJR0lUQUwgSU1BR0lORwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/bAEMABQMEBAQDBQQEBAUFBQYHDAgHBwcHDwsLCQwRDxISEQ8RERMWHBcTFBoVEREYIRgaHR0fHx8TFyIkIh4kHB4fHv/AEMBBQUFBwYHDggIDh4UERQeHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHv/CABEIAcABwAMBIgACEQEDEQH/xAAbAAEBAAMBAQEAAAAAAAAAAAAAAQIDBAUGB//EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAAIAAAACAAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAAgAAAAIAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAASAAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAAAAAACAAAAAgAAAAAIAAAACAAAAAAgAAAAIAAAAAACAAAAAgAAAAAIAAAACAAAAAAkAAAEgAAAAAAJAAABIAAAAAACQAAASAAAAAAAkAAAEgAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAgEBPgBf/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAwEBPgBf/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAQABPwBf/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAgIGPwBf/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAwIGPwBf/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAQABPxBf/9oADAMBAAIAAwAAABDzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";

    // --- KONEKSI SUPABASE ---
    // GANTI DENGAN URL DAN KEY SUPABASE ANDA
    const SUPABASE_URL = 'https://ngcmhilprxndoetdxbzz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nY21oaWxwcnhuZG9ldGR4Ynp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODIyMzIsImV4cCI6MjA3NjY1ODIzMn0.yZzEMF8xICJhF29CtKZ0G7-I6OxiHK485Cda9CsKkEU';

    // Inisialisasi Klien Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // State Aplikasi
    let currentUser = null;
    let currentRole = null;
    let activeChart = null; 
    let studentCache = {}; // Cache untuk menyimpan data siswa per kelas

    // ===== INISIALISASI APLIKASI =====
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('logo').src = logoUrl;
        document.getElementById('dashboard-logo').src = logoUrl;

        document.getElementById('show-register-btn').addEventListener('click', () => toggleForms(true));
        document.getElementById('show-login-btn').addEventListener('click', () => toggleForms(false));
    });

    function toggleForms(showRegister) {
        document.getElementById('login-form').classList.toggle('hidden', showRegister);
        document.getElementById('register-form').classList.toggle('hidden', !showRegister);
        document.getElementById('login-text').classList.toggle('hidden', showRegister);
        document.getElementById('register-text').classList.toggle('hidden', !showRegister);
        document.getElementById('login-error').textContent = '';
        document.getElementById('register-error').textContent = '';
        
        const title = document.querySelector('.login-card h1');
        const subtitle = document.querySelector('.login-card p');

        if (showRegister) {
            title.textContent = 'Daftar Akun Siswa';
            subtitle.textContent = 'Isi data berikut untuk membuat akun baru.';
            document.getElementById('role-selector').value = 'siswa';
            document.getElementById('role-selector').setAttribute('disabled', 'true');
        } else {
            title.textContent = 'Selamat Datang!';
            subtitle.textContent = 'Silakan masuk untuk melanjutkan';
            document.getElementById('role-selector').removeAttribute('disabled');
        }
    }
    
    // ===== UTILITAS LOADING STATE =====
    function setLoading(buttonId, isLoading) {
        const button = document.getElementById(buttonId);
        if(!button) return;
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span><span>Memproses...</span>`;
        } else {
            button.disabled = false;
            // Kembalikan teks tombol berdasarkan ID
            if (buttonId === 'login-button') button.innerHTML = 'Masuk';
            else if (buttonId === 'register-button') button.innerHTML = 'Daftar';
            else if (buttonId === 'save-attendance-button') button.innerHTML = '<i class="fas fa-save mr-2"></i> Simpan Absensi';
            else if (buttonId === 'modal-save-btn') button.innerHTML = 'Simpan';
            else button.innerHTML = button.textContent; // default
        }
    }

    // ===== LOGIKA LOGIN, REGISTER & LOGOUT (TERHUBUNG SUPABASE) =====
    async function handleLogin() {
        const role = document.getElementById('role-selector').value;
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorEl = document.getElementById('login-error');
        errorEl.textContent = '';
        
        if (!username || !password) {
            errorEl.textContent = 'Username dan password tidak boleh kosong.';
            return;
        }

        setLoading('login-button', true);

        // Menggunakan Supabase untuk mencari user
        const { data: userFound, error } = await supabaseClient
            .from('users')
            .select('*')
            .eq('username', username)
            .eq('password', password) // PENTING: Di aplikasi nyata, jangan simpan password sbg plain text.
            .eq('role', role)
            .single(); // .single() mengharapkan 1 hasil atau error

        setLoading('login-button', false);
        
        if (userFound) {
            currentUser = userFound;
            currentRole = role;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = role.charAt(0).toUpperCase() + role.slice(1);
            renderDashboard();
        } else {
            errorEl.textContent = 'Username, password, atau peran salah.';
            console.error('Login Error:', error);
            document.getElementById('password').value = '';
        }
    }

    async function handleRegister() {
        const name = document.getElementById('register-name').value.trim();
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value.trim();
        const token = document.getElementById('register-token').value.trim();
        const errorEl = document.getElementById('register-error');
        errorEl.textContent = '';

        if (!name || !username || !password || !token) {
            errorEl.textContent = 'Semua field wajib diisi.';
            return;
        }
        
        setLoading('register-button', true);

        // 1. Validasi Token Kelas
        const { data: targetClass, error: classError } = await supabaseClient
            .from('classes')
            .select('id')
            .eq('token', token)
            .single();

        if (!targetClass) {
            errorEl.textContent = 'Token kelas tidak valid.';
            setLoading('register-button', false);
            return;
        }

        // 2. Cek jika username sudah ada
        const { data: existingUser, error: userError } = await supabaseClient
            .from('users')
            .select('id')
            .eq('username', username)
            .single();
            
        if (existingUser) {
            errorEl.textContent = 'Username sudah digunakan.';
            setLoading('register-button', false);
            return;
        }
        
        // 3. Insert user baru
        const { error: insertError } = await supabaseClient
            .from('users')
            .insert({
                username: username,
                password: password,
                name: name,
                role: 'siswa',
                class_id: targetClass.id
            });

        setLoading('register-button', false);

        if (insertError) {
            errorEl.textContent = 'Gagal mendaftar. Coba lagi.';
            console.error('Register Error:', insertError);
        } else {
            showModal('Pendaftaran Berhasil!', 'Akun Anda telah dibuat. Silakan masuk.', () => {
                toggleForms(false);
                document.getElementById('username').value = username;
                document.getElementById('password').value = '';
                document.getElementById('register-name').value = '';
                document.getElementById('register-username').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-token').value = '';
            });
        }
    }

    function handleLogout() {
        currentUser = null;
        currentRole = null;
        studentCache = {}; // Hapus cache siswa
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-dashboard').classList.add('hidden');
        document.getElementById('app-content').innerHTML = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        if (activeChart) {
            activeChart.destroy();
            activeChart = null;
        }
    }

    // ===== RENDER DASHBOARD UTAMA BERDASARKAN ROLE =====
    function renderDashboard() {
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = '';
        
        switch (currentRole) {
            case 'admin':
                renderAdminDashboard();
                break;
            case 'guru':
                renderGuruDashboard();
                break;
            case 'siswa':
                renderSiswaDashboard();
                break;
        }
    }

    // ===== LOGIKA & RENDER HALAMAN ADMIN (TERHUBUNG SUPABASE) =====
    function renderAdminDashboard() {
        const template = document.getElementById('admin-template').content.cloneNode(true);
        document.getElementById('app-content').appendChild(template);
        switchAdminView('dashboard');
    }

    // Fungsi switchAdminView diubah untuk menangani loading
    function switchAdminView(view) {
        document.querySelectorAll('#app-content aside .nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`admin-nav-${view}`).classList.add('active');
        
        if (activeChart) activeChart.destroy();
        
        const contentArea = document.getElementById('admin-view-content');
        // Tampilkan spinner loading
        contentArea.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-pink-400"></i></div>`;
        
        // Siapkan template
        const template = document.getElementById(`admin-${view}-view`).content.cloneNode(true);
        
        // Panggil fungsi async yang akan memuat data DAN me-render template
        if (view === 'dashboard') loadAdminDashboardData(template, contentArea);
        if (view === 'guru') loadAdminGuruData(template, contentArea);
        if (view === 'siswa') loadAdminSiswaData(template, contentArea);
        if (view === 'kelas') loadAdminKelasData(template, contentArea);
    }

    async function loadAdminDashboardData(template, contentArea) {
        // Ambil data count dari Supabase
        const { count: guruCount, error: guruErr } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).eq('role', 'guru');
        const { count: siswaCount, error: siswaErr } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).eq('role', 'siswa');
        const { count: kelasCount, error: kelasErr } = await supabaseClient.from('classes').select('*', { count: 'exact', head: true });

        // Ganti spinner dengan konten template
        contentArea.innerHTML = '';
        contentArea.appendChild(template);

        // Isi data ke template
        document.getElementById('admin-total-guru').textContent = guruErr ? 0 : guruCount;
        document.getElementById('admin-total-siswa').textContent = siswaErr ? 0 : siswaCount;
        document.getElementById('admin-total-kelas').textContent = kelasErr ? 0 : kelasCount;

        const ctx = document.getElementById('admin-chart').getContext('2d');
        activeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Guru', 'Siswa', 'Kelas'],
                datasets: [{
                    label: 'Total Entitas dalam Sistem',
                    data: [guruCount, siswaCount, kelasCount],
                    backgroundColor: ['#EC4899', '#F472B6', '#F9A8D4'],
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }
    
    async function loadAdminGuruData(template, contentArea) {
        // Ambil data guru + data kelas yg diampu (join)
        const { data: teachers, error } = await supabaseClient
            .from('users')
            .select(`*, classes(name)`)
            .eq('role', 'guru');

        contentArea.innerHTML = '';
        contentArea.appendChild(template);

        const list = document.getElementById('admin-guru-list');
        list.innerHTML = '';
        if (error || teachers.length === 0) {
            console.error(error);
            list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">${error ? 'Gagal memuat data.' : 'Belum ada data guru.'}</td></tr>`;
            return;
        }

        teachers.forEach(guru => {
            const classesManaged = guru.classes.map(c => c.name).join(', ') || '-';
            const row = `
                <tr class="border-b border-pink-100 hover:bg-pink-50">
                    <td class="p-3">${guru.name}</td>
                    <td class="p-3">${guru.username}</td>
                    <td class="p-3">${classesManaged}</td>
                    <td class="p-3 text-pink-600"><i class="fas fa-edit cursor-pointer mr-3"></i><i class="fas fa-trash cursor-pointer"></i></td>
                </tr>
            `;
            list.innerHTML += row;
        });
    }

    async function loadAdminSiswaData(template, contentArea) {
        const { data: students, error } = await supabaseClient
            .from('users')
            .select(`*, classes(name)`)
            .eq('role', 'siswa');
        
        contentArea.innerHTML = '';
        contentArea.appendChild(template);
        
        const list = document.getElementById('admin-siswa-list');
        list.innerHTML = '';
        if (error || students.length === 0) {
            console.error(error);
            list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">${error ? 'Gagal memuat data.' : 'Belum ada data siswa.'}</td></tr>`;
            return;
        }

        students.forEach(siswa => {
            const studentClass = siswa.classes ? siswa.classes.name : 'Belum ada kelas';
            const row = `
                <tr class="border-b border-pink-100 hover:bg-pink-50">
                    <td class="p-3">${siswa.name}</td>
                    <td class="p-3">${siswa.username}</td>
                    <td class="p-3">${studentClass}</td>
                    <td class="p-3 text-pink-600"><i class="fas fa-edit cursor-pointer mr-3"></i><i class="fas fa-trash cursor-pointer"></i></td>
                </tr>
            `;
            list.innerHTML += row;
        });
    }

    async function loadAdminKelasData(template, contentArea) {
        // Ambil data kelas, join dgn wali kelas (teacher) & hitung jml siswa (students)
        const { data: classes, error } = await supabaseClient
            .from('classes')
            .select(`*, teacher:users(name), students:users(count)`);

        contentArea.innerHTML = '';
        contentArea.appendChild(template);

        const list = document.getElementById('admin-kelas-list');
        list.innerHTML = '';
        if (error || classes.length === 0) {
            console.error(error);
            list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">${error ? 'Gagal memuat data.' : 'Belum ada kelas.'}</td></tr>`;
            return;
        }

        classes.forEach(kelas => {
            const teacherName = kelas.teacher ? kelas.teacher.name : 'Belum ditugaskan';
            const studentCount = kelas.students[0] ? kelas.students[0].count : 0;
            const row = `
                 <tr class="border-b border-pink-100 hover:bg-pink-50">
                    <td class="p-3 font-semibold">${kelas.name}</td>
                    <td class="p-3 font-mono bg-gray-100 rounded">${kelas.token}</td>
                    <td class="p-3">${teacherName}</td>
                    <td class="p-3">${studentCount}</td>
                    <td class="p-3 text-pink-600"><i class="fas fa-edit cursor-pointer mr-3"></i><i class="fas fa-trash cursor-pointer"></i></td>
                </tr>
            `;
            list.innerHTML += row;
        });
    }

    // ===== LOGIKA & RENDER HALAMAN GURU (TERHUBUNG SUPABASE) =====
    async function renderGuruDashboard() {
        const template = document.getElementById('guru-template').content.cloneNode(true);
        document.getElementById('app-content').appendChild(template);
        
        const classSelector = document.getElementById('guru-class-selector');
        classSelector.innerHTML = '<option>Memuat kelas...</option>';

        // Ambil kelas yg diajar oleh guru yg sedang login
        const { data: managedClasses, error } = await supabaseClient
            .from('classes')
            .select('*')
            .eq('teacher_id', currentUser.id); // currentUser.id didapat saat login

        if (error || !managedClasses) {
             document.getElementById('guru-content-area').innerHTML = '<p class="text-center text-gray-500 card">Gagal memuat data kelas.</p>';
             return;
        }
        
        classSelector.innerHTML = ''; 
        managedClasses.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.name;
            classSelector.appendChild(option);
        });
        
        if (managedClasses.length > 0) {
            renderGuruContent();
        } else {
            document.getElementById('guru-content-area').innerHTML = '<p class="text-center text-gray-500 card">Anda belum diampu di kelas manapun.</p>';
        }
    }

    function renderGuruContent() {
        const contentArea = document.getElementById('guru-content-area');
        contentArea.innerHTML = '';
        const template = document.getElementById('guru-content-template').content.cloneNode(true);
        contentArea.appendChild(template);
        switchGuruView('absensi'); // Default view
    }

    function switchGuruView(view) {
        if (activeChart) activeChart.destroy();
        document.querySelectorAll('#guru-content-area aside .nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`guru-nav-${view}`).classList.add('active');
        
        const contentArea = document.getElementById('guru-view-content');
        // Tampilkan spinner
        contentArea.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-pink-400"></i></div>`;
        const template = document.getElementById(`guru-${view}-view`).content.cloneNode(true);

        // Panggil fungsi async
        if (view === 'absensi') loadGuruAbsensi(template, contentArea);
        if (view === 'tugas') loadGuruTugas(template, contentArea);
        if (view === 'laporan') loadGuruLaporan(template, contentArea);
    }
    
    async function loadGuruAbsensi(template, contentArea) {
        const classId = parseInt(document.getElementById('guru-class-selector').value);
        
        // Cek cache dulu
        if (!studentCache[classId]) {
            const { data: students, error } = await supabaseClient
                .from('users')
                .select('id, name')
                .eq('class_id', classId)
                .order('name', { ascending: true });
            if (error) {
                contentArea.innerHTML = `<div class="card"><p class="text-red-500">Gagal memuat daftar siswa.</p></div>`;
                return;
            }
            studentCache[classId] = students; // Simpan ke cache
        }
        
        const students = studentCache[classId];
        const today = new Date().toISOString().slice(0, 10); // Format YYYY-MM-DD

        // Cek absensi hari ini
        const { data: todaysAttendance, error: attendanceError } = await supabaseClient
            .from('attendance')
            .select('student_id, status')
            .eq('date', today)
            .in('student_id', students.map(s => s.id));

        // Buat map untuk cek status
        const attendanceMap = new Map(todaysAttendance.map(att => [att.student_id, att.status]));

        contentArea.innerHTML = '';
        contentArea.appendChild(template);

        const list = document.getElementById('guru-absensi-list');
        list.innerHTML = '';
        
        document.getElementById('absensi-tanggal').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        students.forEach(student => {
            const currentStatus = attendanceMap.get(student.id);
            const statuses = ['Hadir', 'Izin', 'Sakit', 'Alfa'];
            // Buat radio button & auto-check status yg sudah ada
            const radioButtons = statuses.map(status => `
                <td class="p-3 text-center">
                    <label class="cursor-pointer">
                        <input type="radio" name="status-${student.id}" value="${status}" class="form-radio text-pink-600 mr-2" ${currentStatus === status ? 'checked' : ''}> ${status}
                    </label>
                </td>
            `).join('');

            const row = `
                <tr class="border-b border-pink-100" data-student-id="${student.id}">
                    <td class="p-3 font-medium">${student.name}</td>
                    ${radioButtons}
                </tr>
            `;
            list.innerHTML += row;
        });
    }

    // Fungsi BARU untuk menyimpan absensi
    async function handleSaveAttendance() {
        setLoading('save-attendance-button', true);
        const attendanceRows = document.querySelectorAll('#guru-absensi-list tr');
        const today = new Date().toISOString().slice(0, 10);
        
        const recordsToUpsert = [];
        attendanceRows.forEach(row => {
            const studentId = row.dataset.studentId;
            const selectedStatus = row.querySelector('input[type="radio"]:checked');
            if (studentId && selectedStatus) {
                recordsToUpsert.push({
                    student_id: parseInt(studentId),
                    date: today,
                    status: selectedStatus.value
                });
            }
        });

        if (recordsToUpsert.length > 0) {
            // upsert = update jika ada, insert jika tidak ada
            const { error } = await supabaseClient
                .from('attendance')
                .upsert(recordsToUpsert, { onConflict: 'student_id, date' });

            if (error) {
                console.error('Save Attendance Error:', error);
                showModal('Gagal!', 'Gagal menyimpan data absensi. Silakan coba lagi.', () => {});
            } else {
                showModal('Berhasil!', 'Data absensi hari ini telah berhasil disimpan.', () => {});
            }
        }
        setLoading('save-attendance-button', false);
    }

    async function loadGuruTugas(template, contentArea) {
        const classId = parseInt(document.getElementById('guru-class-selector').value);
        // Ambil tugas, hitung jumlah submission, dan jumlah siswa di kelas
        const { data: assignments, error } = await supabaseClient
            .from('assignments')
            .select(`*, submissions(count), classes(users(count))`)
            .eq('class_id', classId);

        contentArea.innerHTML = '';
        contentArea.appendChild(template);

        const list = document.getElementById('guru-tugas-list');
        list.innerHTML = '';

        if (error || assignments.length === 0) {
            console.error(error);
            list.innerHTML = `<p class="text-center text-gray-500 p-4">${error ? 'Gagal memuat tugas.' : 'Belum ada tugas untuk kelas ini.'}</p>`;
            return;
        }

        assignments.forEach(assignment => {
            const collectedCount = assignment.submissions[0]?.count || 0;
            const totalStudents = assignment.classes.users[0]?.count || 0;
            const card = `
                <div class="border border-pink-200 p-4 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-800">${assignment.title}</h4>
                            <p class="text-sm text-gray-600">${assignment.description}</p>
                            <p class="text-xs text-red-600 mt-1">Batas Waktu: ${new Date(assignment.deadline).toLocaleString('id-ID')}</p>
                        </div>
                        <div class="text-right">
                           <p class="font-semibold text-lg">${collectedCount}/${totalStudents}</p>
                           <p class="text-sm text-gray-500">Terkumpul</p>
                        </div>
                    </div>
                </div>
            `;
            list.innerHTML += card;
        });
    }

    async function loadGuruLaporan(template, contentArea) {
        const classId = parseInt(document.getElementById('guru-class-selector').value);
        const today = new Date();
        // Ambil hari pertama dan terakhir bulan ini
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0, 10);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().slice(0, 10);
        
        // Pastikan cache siswa ada
        if (!studentCache[classId]) {
            // Trik: panggil loadGuruAbsensi hanya untuk mengisi cache
            await loadGuruAbsensi(document.createElement('div'), document.createElement('div'));
        }
        // Jika masih kosong (gagal fetch), keluar
        if (!studentCache[classId]) {
             contentArea.innerHTML = `<div class="card text-red-500">Gagal memuat data siswa untuk laporan.</div>`;
             return;
        }

        const studentIds = studentCache[classId].map(s => s.id);

        // Ambil data absensi untuk semua siswa di kelas ini, dalam rentang tgl bulan ini
        const { data, error } = await supabaseClient
            .from('attendance')
            .select('status')
            .in('student_id', studentIds)
            .gte('date', firstDay)
            .lte('date', lastDay);

        contentArea.innerHTML = '';
        contentArea.appendChild(template);

        if (error) {
            contentArea.innerHTML = `<div class="card text-red-500">Gagal memuat data laporan.</div>`;
            return;
        }

        // Hitung statistik
        const stats = { 'Hadir': 0, 'Izin': 0, 'Sakit': 0, 'Alfa': 0 };
        data.forEach(item => {
            if (stats.hasOwnProperty(item.status)) {
                stats[item.status]++;
            }
        });
        
         const ctx = document.getElementById('guru-chart-absensi').getContext('2d');
         activeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(stats),
                datasets: [{
                    label: 'Status Kehadiran Bulan Ini',
                    data: Object.values(stats),
                    backgroundColor: ['#10B981', '#F59E0B', '#3B82F6', '#EF4444'],
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } } }
        });
    }

    // ===== LOGIKA & RENDER HALAMAN SISWA (TERHUBUNG SUPABASE) =====
    function renderSiswaDashboard() {
        const template = document.getElementById('siswa-template').content.cloneNode(true);
        document.getElementById('app-content').appendChild(template);
        switchSiswaView('dashboard');
    }

    function switchSiswaView(view) {
        if (activeChart) activeChart.destroy();
        document.querySelectorAll('#app-content aside .nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`siswa-nav-${view}`).classList.add('active');
        
        const contentArea = document.getElementById('siswa-view-content');
        contentArea.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-pink-400"></i></div>`;
        const template = document.getElementById(`siswa-${view}-view`).content.cloneNode(true);

        if (view === 'dashboard') loadSiswaDashboard(template, contentArea);
        if (view === 'tugas') loadSiswaTugas(template, contentArea);
        if (view === 'riwayat') loadSiswaRiwayat(template, contentArea);
    }
    
    async function loadSiswaDashboard(template, contentArea){
        // 1. Ambil data absensi bulan ini
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0, 10);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().slice(0, 10);
        
        const { data: attendanceData, error: attendanceError } = await supabaseClient
            .from('attendance')
            .select('status')
            .eq('student_id', currentUser.id)
            .gte('date', firstDay)
            .lte('date', lastDay);

        // 2. Ambil tugas mendatang
        const { data: assignments, error: assignmentError } = await supabaseClient
            .from('assignments')
            .select(`*, submissions!left(status)`)
            .eq('class_id', currentUser.class_id)
            .gte('deadline', new Date().toISOString()) // Tenggatnya belum lewat
            .order('deadline', { ascending: true })
            .limit(5);

        contentArea.innerHTML = '';
        contentArea.appendChild(template);
        
        // 3. Render Chart Absensi
        const attendanceStats = { 'Hadir': 0, 'Izin': 0, 'Sakit': 0, 'Alfa': 0 };
        if (attendanceData) {
            attendanceData.forEach(item => {
                if (attendanceStats.hasOwnProperty(item.status)) {
                    attendanceStats[item.status]++;
                }
            });
        }
        const chartCtx = document.getElementById('siswa-chart-absensi').getContext('2d');
        activeChart = new Chart(chartCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(attendanceStats),
                datasets: [{
                    data: Object.values(attendanceStats),
                    backgroundColor: ['#10B981', '#F59E0B', '#3B82F6', '#EF4444'],
                }]
            },
            options: { responsive: true }
        });

        // 4. Render Tugas Mendatang
        const upcomingList = document.getElementById('siswa-upcoming-tugas');
        upcomingList.innerHTML = '';
        if (assignments && assignments.length > 0) {
            assignments.forEach(a => {
                // Cek apakah sudah submit (submissions!left)
                const isSubmitted = a.submissions && a.submissions.length > 0;
                const item = `
                    <div class="flex justify-between items-center text-sm p-2 rounded ${isSubmitted ? 'bg-green-50' : 'bg-gray-50'}">
                        <div>
                            <p class="font-semibold">${a.title}</p>
                            <p class="text-xs text-gray-500">Tenggat: ${new Date(a.deadline).toLocaleDateString('id-ID')}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${isSubmitted ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}">
                            ${isSubmitted ? 'Terkumpul' : 'Belum'}
                        </span>
                    </div>
                `;
                upcomingList.innerHTML += item;
            });
        } else {
            upcomingList.innerHTML = '<p class="text-gray-500 text-sm">Tidak ada tugas yang akan datang.</p>';
        }
    }
    
    async function loadSiswaTugas(template, contentArea){
        // Ambil semua tugas untuk kelas siswa ini, dan status submission-nya
        const { data: assignments, error } = await supabaseClient
            .from('assignments')
            .select(`*, submissions!left(status)`)
            .eq('class_id', currentUser.class_id)
            .order('deadline', { ascending: false });

        contentArea.innerHTML = '';
        contentArea.appendChild(template);
        
        const list = document.getElementById('siswa-tugas-list');
        list.innerHTML = '';

        if (error || assignments.length === 0) {
            list.innerHTML = `<p class="text-center text-gray-500 p-4">${error ? 'Gagal memuat tugas.' : 'Hore, tidak ada tugas!'}</p>`;
            return;
        }

        assignments.forEach(a => {
             const status = a.submissions[0]?.status || 'Belum Mengumpulkan';
             let statusClass = 'bg-gray-200 text-gray-800';
             if (status === 'Dinilai') statusClass = 'bg-blue-200 text-blue-800';
             if (status === 'Terkumpul') statusClass = 'bg-green-200 text-green-800';

            const card = `
                <div class="border border-pink-200 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-gray-800">${a.title}</h4>
                        <p class="text-sm text-gray-600">${a.description || ''}</p>
                        <p class="text-xs text-red-600 mt-1">Batas Waktu: ${new Date(a.deadline).toLocaleString('id-ID')}</p>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                         <span class-"px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">${status}</span>
                         <button class="btn-secondary text-xs mt-2 w-full ${status !== 'Belum Mengumpulkan' ? 'hidden':''}">Kumpulkan</button>
                    </div>
                </div>
            `;
            list.innerHTML += card;
        });
    }

    async function loadSiswaRiwayat(template, contentArea) {
        // Ambil semua submission milik siswa yg login, dan join ke judul tugasnya
        const { data: submissions, error } = await supabaseClient
            .from('submissions')
            .select(`*, assignment:assignments(title)`)
            .eq('student_id', currentUser.id)
            .neq('status', 'Belum Mengumpulkan')
            .order('submitted_at', { ascending: false });

        contentArea.innerHTML = '';
        contentArea.appendChild(template);
        
        const list = document.getElementById('siswa-riwayat-list');
        list.innerHTML = '';
        if (error || submissions.length === 0) {
            list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">${error ? 'Gagal memuat riwayat.' : 'Belum ada riwayat tugas.'}</td></tr>`;
            return;
        }

        submissions.forEach(s => {
            const statusBadge = s.status === "Dinilai" ? "status-hadir" : "status-izin";
            const row = `
                 <tr class="border-b border-pink-100 hover:bg-pink-50">
                    <td class="p-3 font-semibold">${s.assignment.title}</td>
                    <td class="p-3">${s.submitted_at ? new Date(s.submitted_at).toLocaleDateString('id-ID') : '-'}</td>
                    <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusBadge}">${s.status}</span></td>
                    <td class="p-3 font-bold text-lg text-pink-700">${s.grade || '-'}</td>
                    <td class="p-3 text-sm text-gray-600 italic">"${s.feedback || 'Belum ada feedback.'}"</td>
                </tr>
            `;
            list.innerHTML += row;
        });
    }

    // ===== UTILITAS MODAL (SIMPLE & FORM) =====
    function showModal(title, message, onOk) {
        const modalContainer = document.getElementById('form-modal-container');
        const modal = document.createElement('div');
        modal.className = 'modal-backdrop';
        modal.innerHTML = `
            <div class="card w-full max-w-sm text-center modal-content">
                <h3 class="font-bold text-xl text-gray-800 mb-2">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <button id="modal-ok-btn" class="btn-primary w-full">OK</button>
            </div>
        `;
        modalContainer.appendChild(modal);

        setTimeout(() => modal.classList.add('visible'), 10);
        
        modal.querySelector('#modal-ok-btn').onclick = () => {
            modal.classList.remove('visible');
            setTimeout(() => {
                modalContainer.innerHTML = '';
                if (onOk) onOk();
            }, 200);
        };
    }
    
    async function showFormModal(type) {
        const modalContainer = document.getElementById('form-modal-container');
        const modal = document.createElement('div');
        modal.className = 'modal-backdrop';
        modal.innerHTML = `
            <div class="card w-full max-w-lg modal-content">
                <div id="form-content"></div>
                <p id="form-error" class="text-red-500 text-sm mt-4 h-4 text-left"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="modal-cancel-btn" class="btn-secondary">Batal</button>
                    <button id="modal-save-btn" class="btn-primary">Simpan</button>
                </div>
            </div>
        `;
        
        const formTemplate = document.getElementById(`admin-form-${type}`).content.cloneNode(true);
        modal.querySelector('#form-content').appendChild(formTemplate);
        modalContainer.appendChild(modal);

        // Ambil data untuk dropdowns dari Supabase
        try {
            if (type === 'siswa') {
                const classSelect = modal.querySelector('#form-siswa-kelas');
                classSelect.innerHTML = '<option>Memuat...</option>';
                const { data: classes, error } = await supabaseClient.from('classes').select('id, name');
                if (error) throw error;
                classSelect.innerHTML = '';
                classes.forEach(c => classSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            }
            if (type === 'kelas') {
                const teacherSelect = modal.querySelector('#form-kelas-guru');
                teacherSelect.innerHTML = '<option>Memuat...</option>';
                const { data: teachers, error } = await supabaseClient.from('users').select('id, name').eq('role', 'guru');
                if (error) throw error;
                teacherSelect.innerHTML = '';
                teachers.forEach(g => teacherSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`);
            }
        } catch (e) {
             modal.querySelector('#form-error').textContent = 'Gagal memuat data dropdown.';
        }

        setTimeout(() => modal.classList.add('visible'), 10);

        const closeModal = () => {
            modal.classList.remove('visible');
            setTimeout(() => { modalContainer.innerHTML = ''; }, 200);
        };

        modal.querySelector('#modal-cancel-btn').onclick = closeModal;
        modal.querySelector('#modal-save-btn').onclick = () => handleFormSubmit(type, closeModal);
    }
    
    async function handleFormSubmit(type, closeModalCallback) {
        const errorEl = document.querySelector('#form-error');
        errorEl.textContent = '';
        setLoading('modal-save-btn', true);

        try {
            let error;
            switch (type) {
                case 'guru':
                    const guruName = document.getElementById('form-guru-name').value.trim();
                    const guruUsername = document.getElementById('form-guru-username').value.trim();
                    const guruPassword = document.getElementById('form-guru-password').value.trim();
                    if (!guruName || !guruUsername || !guruPassword) throw new Error("Semua field wajib diisi.");
                    
                    ({ error } = await supabaseClient.from('users').insert({
                        name: guruName, username: guruUsername, password: guruPassword, role: 'guru'
                    }));
                    if (error) throw error;
                    
                    switchAdminView('guru'); // Refresh data
                    break;
                    
                case 'siswa':
                    const siswaName = document.getElementById('form-siswa-name').value.trim();
                    const siswaUsername = document.getElementById('form-siswa-username').value.trim();
                    const siswaPassword = document.getElementById('form-siswa-password').value.trim();
                    const classId = parseInt(document.getElementById('form-siswa-kelas').value);
                    if (!siswaName || !siswaUsername || !siswaPassword) throw new Error("Semua field wajib diisi.");

                    ({ error } = await supabaseClient.from('users').insert({
                        name: siswaName, username: siswaUsername, password: siswaPassword, role: 'siswa', class_id: classId
                    }));
                    if (error) throw error;

                    switchAdminView('siswa'); // Refresh data
                    break;
                    
                case 'kelas':
                    const kelasName = document.getElementById('form-kelas-name').value.trim();
                    const teacherId = parseInt(document.getElementById('form-kelas-guru').value);
                    if (!kelasName) throw new Error("Nama kelas wajib diisi.");

                    const token = Math.random().toString(36).substring(2, 8).toUpperCase();
                    ({ error } = await supabaseClient.from('classes').insert({
                        name: kelasName, token: token, teacher_id: teacherId
                    }));
                    if (error) throw error;
                    
                    switchAdminView('kelas'); // Refresh data
                    break;
            }
            closeModalCallback();
        } catch (e) {
            console.error('Form Submit Error:', e);
            errorEl.textContent = e.message.includes('unique constraint') ? 'Username atau Token sudah ada.' : e.message;
        } finally {
            setLoading('modal-save-btn', false);
        }
    }

    </script>
</body>
</html>

