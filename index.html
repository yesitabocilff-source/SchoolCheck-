<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolCheck - Absensi & Tugas Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.292.0/lucide.min.css" xintegrity="sha512-VimQvA3+NfmbNsCKpNoIAiQGscC1pNE5Lp3k/3GeVU6QG/2/GKaPo3lQZ9LSAe//bFgU/cO/w2re7IuS20kL8A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="app" class="min-h-screen">
        <!-- Loading Spinner -->
        <div id="loading-view" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-[9999]">
            <div class="flex flex-col items-center">
                <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-slate-600">Memuat Aplikasi...</p>
            </div>
        </div>

        <!-- Login View -->
        <div id="login-view" class="view min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-indigo-600">SchoolCheck</h1>
                    <p class="text-slate-500 mt-2">Selamat datang kembali! Silakan masuk.</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-slate-600 mb-2">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-slate-600 mb-2">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Masuk</button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
                 <div class="text-center mt-4">
                    <p class="text-sm text-slate-500">Belum punya akun? <a href="#" id="show-register-link" class="font-medium text-indigo-600 hover:underline">Daftar di sini</a></p>
                </div>
            </div>
        </div>
        
        <!-- Register View -->
        <div id="register-view" class="view min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Daftar Akun Baru</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-name" class="block text-sm font-medium text-slate-600 mb-2">Nama Lengkap</label>
                        <input type="text" id="register-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-slate-600 mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-sm font-medium text-slate-600 mb-2">Password</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-role" class="block text-sm font-medium text-slate-600 mb-2">Saya adalah seorang</label>
                        <select id="register-role" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-white">
                            <option value="Siswa">Siswa</option>
                            <option value="Guru">Guru</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Daftar</button>
                    <p id="register-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
                <div class="text-center mt-4">
                    <p class="text-sm text-slate-500">Sudah punya akun? <a href="#" id="show-login-link" class="font-medium text-indigo-600 hover:underline">Masuk</a></p>
                </div>
            </div>
        </div>

        <!-- Main App Layout (Shared Header) -->
        <div id="main-app-view" class="view min-h-screen">
            <header class="bg-white shadow-md sticky top-0 z-50">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">SchoolCheck</h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <p id="user-name" class="font-semibold text-slate-700"></p>
                                <p id="user-role" class="text-sm text-slate-500"></p>
                            </div>
                            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Logout</button>
                        </div>
                    </div>
                </div>
            </header>
            
            <main class="container mx-auto p-4 sm:p-6 lg:p-8">
                <!-- Admin Dashboard -->
                <div id="admin-dashboard" class="view">
                    <h2 class="text-2xl font-bold mb-6">Dasbor Admin</h2>
                    <!-- Content will be generated by JS -->
                </div>

                <!-- Teacher Dashboard -->
                <div id="teacher-dashboard" class="view">
                    <h2 class="text-2xl font-bold mb-6">Dasbor Guru</h2>
                    <div id="teacher-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Content will be generated by JS -->
                    </div>
                </div>

                <!-- Student Dashboard -->
                <div id="student-dashboard" class="view">
                    <h2 class="text-2xl font-bold mb-6">Dasbor Siswa</h2>
                    <div id="student-content" class="space-y-6">
                        <!-- Absensi Section -->
                        <div class="bg-white p-6 rounded-lg shadow">
                             <h3 class="text-xl font-semibold mb-4">Absensi Hari Ini</h3>
                             <p class="text-slate-600 mb-4">Tanggal: <span id="current-date"></span></p>
                             <div id="attendance-status" class="text-center p-4 rounded-md"></div>
                             <div id="attendance-action" class="mt-4"></div>
                        </div>
                        <!-- Tugas Section -->
                         <div class="bg-white p-6 rounded-lg shadow">
                             <h3 class="text-xl font-semibold mb-4">Daftar Tugas</h3>
                             <div id="student-assignments-list" class="space-y-4">
                                 <p class="text-slate-500">Tidak ada tugas saat ini.</p>
                             </div>
                         </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: Firebase Configuration ---
        // Canvas will automatically provide the firebase config.
        const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Set session persistence
        setPersistence(auth, browserLocalPersistence);

        // --- State Management ---
        let currentUser = null;
        let userData = null;

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const mainAppView = document.getElementById('main-app-view');
        const loadingView = document.getElementById('loading-view');
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');

        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const logoutButton = document.getElementById('logout-button');

        // --- UI Control ---
        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
            }
        }
        
        function showDashboard(role) {
            views.forEach(view => view.classList.remove('active'));
            mainAppView.classList.add('active');
            if (role === 'Admin') {
                document.getElementById('admin-dashboard').classList.add('active');
            } else if (role === 'Guru') {
                document.getElementById('teacher-dashboard').classList.add('active');
            } else if (role === 'Siswa') {
                document.getElementById('student-dashboard').classList.add('active');
            }
        }


        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    userData = userDocSnap.data();
                    document.getElementById('user-name').textContent = userData.name;
                    document.getElementById('user-role').textContent = userData.role;
                    showDashboard(userData.role);
                    initializeAppUI(userData.role);
                } else {
                    // Handle case where user exists in Auth but not in Firestore
                    console.error("User data not found in Firestore.");
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                userData = null;
                showView('login-view');
            }
            loadingView.style.display = 'none';
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                loginError.textContent = 'Email atau password salah. Coba lagi.';
                console.error("Login error:", error);
            }
        });
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = registerForm['register-name'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const role = registerForm['register-role'].value;
            registerError.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Save user data to Firestore
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    role: role
                });
                
                // onAuthStateChanged will handle UI switch
            } catch (error) {
                registerError.textContent = 'Gagal mendaftar. ' + error.message;
                console.error("Registration error:", error);
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            showView('register-view');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            showView('login-view');
        });

        // --- App UI Initialization based on Role ---
        function initializeAppUI(role) {
            if (role === 'Siswa') {
                setupStudentDashboard();
            } else if (role === 'Guru') {
                setupTeacherDashboard();
            } else if (role === 'Admin') {
                setupAdminDashboard();
            }
        }
        
        // --- Siswa Dashboard ---
        async function setupStudentDashboard() {
            const dateEl = document.getElementById('current-date');
            const statusEl = document.getElementById('attendance-status');
            const actionEl = document.getElementById('attendance-action');
            
            const today = new Date();
            const dateString = today.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const dateKey = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            dateEl.textContent = dateString;

            // Mock check: in a real app, this would query a class roster
            const attendanceDocRef = doc(db, "attendance", dateKey, "students", currentUser.uid);
            const attendanceDoc = await getDoc(attendanceDocRef);

            if (attendanceDoc.exists()) {
                const attendanceData = attendanceDoc.data();
                updateAttendanceStatusUI(attendanceData.status);
                actionEl.innerHTML = <p class="text-center text-slate-500">Anda sudah melakukan absensi hari ini.</p>;
            } else {
                statusEl.textContent = 'Belum Absen';
                statusEl.className = 'text-center p-4 rounded-md bg-yellow-100 text-yellow-800 font-medium';
                actionEl.innerHTML = `
                    <div class="flex justify-center space-x-4">
                        <button data-status="Hadir" class="attendance-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Hadir</button>
                        <button data-status="Izin" class="attendance-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Izin</button>
                        <button data-status="Sakit" class="attendance-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg">Sakit</button>
                    </div>`;

                document.querySelectorAll('.attendance-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const status = e.target.dataset.status;
                        await recordAttendance(status, dateKey);
                    });
                });
            }
        }

        function updateAttendanceStatusUI(status) {
            const statusEl = document.getElementById('attendance-status');
            statusEl.textContent = status;
            let statusClass = '';
            switch(status) {
                case 'Hadir': statusClass = 'bg-green-100 text-green-800'; break;
                case 'Izin': statusClass = 'bg-blue-100 text-blue-800'; break;
                case 'Sakit': statusClass = 'bg-orange-100 text-orange-800'; break;
                default: statusClass = 'bg-slate-100 text-slate-800';
            }
            statusEl.className = text-center p-4 rounded-md font-medium ${statusClass};
        }

        async function recordAttendance(status, dateKey) {
            const attendanceDocRef = doc(db, "attendance", dateKey, "students", currentUser.uid);
            try {
                await setDoc(attendanceDocRef, {
                    status: status,
                    name: userData.name,
                    timestamp: new Date()
                });
                updateAttendanceStatusUI(status);
                document.getElementById('attendance-action').innerHTML = <p class="text-center text-slate-500">Absensi berhasil dicatat.</p>;
            } catch (error) {
                console.error("Error recording attendance: ", error);
                document.getElementById('attendance-action').innerHTML = <p class="text-center text-red-500">Gagal mencatat absensi.</p>;
            }
        }


        // --- Guru Dashboard (Placeholder) ---
        function setupTeacherDashboard() {
            const contentEl = document.getElementById('teacher-content');
            contentEl.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-lg mb-2">Absensi Hari Ini</h3>
                    <p class="text-slate-500 mb-4">Lihat dan kelola absensi siswa untuk kelas Anda.</p>
                    <button class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600">Buka Absensi</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-lg mb-2">Manajemen Tugas</h3>
                    <p class="text-slate-500 mb-4">Buat tugas baru dan lihat pengumpulan dari siswa.</p>
                    <button class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600">Kelola Tugas</button>
                </div>
            `;
        }

        // --- Admin Dashboard (Placeholder) ---
        function setupAdminDashboard() {
            const contentEl = document.getElementById('admin-dashboard');
            contentEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Manajemen Pengguna</h3>
                        <p class="text-slate-500 mb-4">Tambah, edit, atau hapus akun guru dan siswa.</p>
                        <button class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600">Kelola Pengguna</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold text-lg mb-2">Manajemen Kelas</h3>
                        <p class="text-slate-500 mb-4">Buat kelas baru dan masukkan siswa serta guru.</p>
                        <button class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600">Kelola Kelas</button>
                    </div>
                </div>
            `;
        }


        // --- Initial Load ---
        showView('loading-view');

    </script>
</body>
</html>